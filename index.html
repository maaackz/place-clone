<!DOCTYPE html>
<html>
<head>
  <title>place clone</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f8f8f8; }
    canvas { border: 2px solid black; image-rendering: pixelated; cursor: crosshair; }
    .palette { margin: 10px; }
    .color { width: 20px; height: 20px; display: inline-block; cursor: pointer; border: 1px solid #000; }
    button { margin-top: 10px; padding: 5px 10px; }
  </style>
</head>
<body>

<h1>üé® place clone</h1>
<canvas id="canvas" width="500" height="500"></canvas>

<div class="palette" id="palette"></div>
<button onclick="resetCanvas()">üßπ Reset Canvas</button>
<p id="status">Click a pixel to color it</p>

<script>
const api = "https://script.google.com/macros/s/AKfycbz9te2Hdo7Sz3NeKZdQ3exCmX-NplQ9PUS9oJ_Bb9JRb9W1IcXa2w7sYGxdWYDqpgvw/exec";
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gridSize = 50;
const pixelSize = canvas.width / gridSize;
const paletteColors = ["#000000", "#ffffff", "#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff", "#00ffff"];
let selectedColor = paletteColors[0];

// üé® Build color palette
const palette = document.getElementById("palette");
paletteColors.forEach(color => {
  const swatch = document.createElement("div");
  swatch.className = "color";
  swatch.style.backgroundColor = color;
  swatch.onclick = () => selectedColor = color;
  palette.appendChild(swatch);
});

// üß± Draw the grid
function drawGrid(grid) {
  for (let y = 0; y < gridSize; y++) {
    for (let x = 0; x < gridSize; x++) {
      ctx.fillStyle = grid[y][x] || "#ffffff";
      ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
    }
  }
}

// ‚úÖ JSONP utility with dynamic callback names
function jsonpFetch(url) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Math.random().toString(36).substring(2);
    window[callbackName] = data => {
      resolve(data);
      delete window[callbackName];
      script.remove();
    };
    const script = document.createElement("script");
    script.src = `${url}&callback=${callbackName}`;
    script.onerror = () => {
      reject(new Error("JSONP request failed"));
      delete window[callbackName];
      script.remove();
    };
    document.body.appendChild(script);
  });
}

// üåê Load canvas
async function loadGrid() {
  try {
    const json = await jsonpFetch(api + "?action=get");
    if (json.success) {
      drawGrid(json.data);
      document.getElementById("status").textContent = "Canvas loaded";
    } else {
      document.getElementById("status").textContent = "Failed to load canvas: " + json.message;
    }
  } catch (err) {
    document.getElementById("status").textContent = "Error loading canvas";
  }
}

// ‚úÖ Update pixel using GET + JSONP
async function updatePixel(x, y, color) {
  try {
    const encodedColor = encodeURIComponent(color);
    const url = `${api}?action=update&x=${x}&y=${y}&color=${encodedColor}`;
    const json = await jsonpFetch(url);
    return json.success;
  } catch (err) {
    console.error("Update failed", err);
    return false;
  }
}

// üßπ Reset canvas using GET + JSONP
async function resetCanvas() {
  document.getElementById("status").textContent = "Resetting canvas...";
  try {
    const json = await jsonpFetch(api + "?action=reset");
    if (json.success) {
      await loadGrid();
      document.getElementById("status").textContent = "Canvas reset!";
    } else {
      document.getElementById("status").textContent = "Failed to reset canvas: " + json.message;
    }
  } catch (err) {
    document.getElementById("status").textContent = "Error resetting canvas";
  }
}

// üéØ Handle canvas clicks
canvas.addEventListener("click", async (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / pixelSize);
  const y = Math.floor((e.clientY - rect.top) / pixelSize);

  document.getElementById("status").textContent = `Placing at (${x}, ${y})...`;

  const success = await updatePixel(x, y, selectedColor);
  if (success) {
    await loadGrid();
    document.getElementById("status").textContent = `Placed color ${selectedColor} at (${x}, ${y})`;
  } else {
    document.getElementById("status").textContent = `Failed to place color at (${x}, ${y})`;
  }
});

// ‚è± Auto-refresh every 5s
setInterval(loadGrid, 5000);
loadGrid();
</script>

</body>
</html>
